{{- if .Values.hpa.enabled }}  # Verifica se o HPA est√° ativado nas configura√ß√µes do Helm.
apiVersion: autoscaling/v2     # Vers√£o da API para HPA com suporte a m√©tricas avan√ßadas.
kind: HorizontalPodAutoscaler  # Tipo de recurso: Autoscaler Horizontal.
metadata:
  name: {{ include "fiap-hackathon-worker.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "fiap-hackathon-worker.labels" . | nindent 4 }}

spec:
  minReplicas: {{ .Values.hpa.minReplicas | default 1 }}  # N√∫mero m√≠nimo de r√©plicas (redund√¢ncia m√≠nima).
  maxReplicas: {{ .Values.hpa.maxReplicas | default 2 }}  # N√∫mero m√°ximo de r√©plicas (capacidade de escala).

  # üîé Defini√ß√£o das m√©tricas que ir√£o disparar o escalonamento
  metrics:
    # üìà Escala baseada na utiliza√ß√£o da CPU
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization                  # Tipo de alvo: Utiliza√ß√£o em porcentagem.
          averageUtilization: {{ .Values.hpa.cpuUtilization | default 60 }}  # Escala quando o uso m√©dio de CPU passa de 60%.

    # üìà Escala baseada na utiliza√ß√£o de mem√≥ria
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization                  # Tipo de alvo: Utiliza√ß√£o em porcentagem.
          averageUtilization: {{ .Values.hpa.memoryUtilization | default 70 }}  # Escala quando o uso m√©dio de mem√≥ria passa de 70%.

  # ‚öôÔ∏è Defini√ß√£o do comportamento de escalonamento
  behavior:
    # üìà Configura√ß√£o para escalar para cima (mais r√©plicas)
    scaleUp:
      stabilizationWindowSeconds: 30  # Tempo de espera de 30 segundos antes de escalar.
      policies:
        - type: Percent               # Escalona com base em percentual.
          value: 75                   # Aumenta at√© 75% das r√©plicas existentes.
          periodSeconds: 15           # Verifica a cada 15 segundos.

    # üìâ Configura√ß√£o para escalar para baixo (menos r√©plicas)
    scaleDown:
      stabilizationWindowSeconds: 30  # Tempo de espera de 30 segundos antes de reduzir.
      policies:
        - type: Percent                # Reduz com base em percentual.
          value: 75                    # Diminui at√© 75% das r√©plicas.
          periodSeconds: 15           # Verifica a cada 15 segundos.

  # üîó Refer√™ncia ao Deployment que ser√° escalado
  scaleTargetRef:
    apiVersion: apps/v1                # Vers√£o da API do Deployment.
    kind: Deployment                   # Tipo de recurso: Deployment.
    name: {{ include "fiap-hackathon-worker.fullname" . }}
{{- end}}